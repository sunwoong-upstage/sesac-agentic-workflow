"""Travel planning agent tools: RAG-based knowledge search, budget estimation, web search."""

import os
import logging
import requests
from langchain_core.tools import tool
from langchain_core.documents import Document
from pydantic import BaseModel, Field

logger = logging.getLogger(__name__)

TRAVEL_KNOWLEDGE_BASE = [
    {
        "id": "KR-001",
        "category": "êµ­ë‚´ì—¬í–‰",
        "title": "ì œì£¼ë„ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ì œì£¼ë„ëŠ” í•œêµ­ ìµœëŒ€ì˜ ì„¬ìœ¼ë¡œ, í•œë¼ì‚°, ì„±ì‚°ì¼ì¶œë´‰, ë§Œì¥êµ´ ë“± ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ìì—°ìœ ì‚°ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë´„ì—ëŠ” ìœ ì±„ê½ƒ, ì—¬ë¦„ì—ëŠ” í•´ìˆ˜ìš•, ê°€ì„ì—ëŠ” ì–µìƒˆ, ê²¨ìš¸ì—ëŠ” í•œë¼ì‚° ì„¤ê²½ì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤. ë Œí„°ì¹´ ì—¬í–‰ì´ ê°€ì¥ í¸ë¦¬í•˜ë©°, ë™ìª½-ì„œìª½ í•´ì•ˆë„ë¡œ ë“œë¼ì´ë¸Œê°€ ì¸ê¸°ì…ë‹ˆë‹¤. í‘ë¼ì§€, í•´ì‚°ë¬¼, ê°ê·¤ì´ ëŒ€í‘œ ë¨¹ê±°ë¦¬ì…ë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” ì„±ì‚°ì¼ì¶œë´‰, í•œë¼ì‚° êµ­ë¦½ê³µì›, ë§Œì¥êµ´, ì²œì§€ì—°í­í¬, ìš°ë„, ì¤‘ë¬¸ê´€ê´‘ë‹¨ì§€, í˜‘ì¬í•´ìˆ˜ìš•ì¥ì´ ìˆìŠµë‹ˆë‹¤. ë§›ì§‘ìœ¼ë¡œëŠ” í‘ë¼ì§€ê±°ë¦¬(ë…¸í˜•ë™), ë™ë¬¸ì‹œì¥, ì œì£¼ í•´ì‚°ë¬¼ ë§›ì§‘ê±°ë¦¬, í•œë¦¼ ì¹¼êµ­ìˆ˜ê±°ë¦¬ê°€ ìœ ëª…í•©ë‹ˆë‹¤. ì• ì›” ì¹´í˜ê±°ë¦¬, ì›”ì •ë¦¬ ì¹´í˜ê±°ë¦¬, í˜‘ì¬ ì¹´í˜ê±°ë¦¬ë„ ì¸ê¸°ì…ë‹ˆë‹¤. ê°ê·¤ë”°ê¸° ì²´í—˜, í•´ë…€ ì²´í—˜, ìŠ¹ë§ˆ ì²´í—˜, ì˜¬ë ˆê¸¸ íŠ¸ë ˆí‚¹ ë“±ì˜ í™œë™ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    },
    {
        "id": "KR-002",
        "category": "êµ­ë‚´ì—¬í–‰",
        "title": "ë¶€ì‚° ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ë¶€ì‚°ì€ í•œêµ­ ì œ2ì˜ ë„ì‹œë¡œ, í•´ìš´ëŒ€, ê´‘ì•ˆë¦¬, ê°ì²œë¬¸í™”ë§ˆì„, ìê°ˆì¹˜ì‹œì¥ì´ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. KTXë¡œ ì„œìš¸ì—ì„œ 2ì‹œê°„ 30ë¶„ì´ë©´ ë„ì°©í•©ë‹ˆë‹¤. ë¼ì§€êµ­ë°¥, ë°€ë©´, ì”¨ì•—í˜¸ë–¡ì´ ëŒ€í‘œ ìŒì‹ì´ë©°, ì˜í™”ì˜ì „ë‹¹, BIFF ê´‘ì¥ ë“± ë¬¸í™”ì‹œì„¤ë„ í’ë¶€í•©ë‹ˆë‹¤. ì—¬ë¦„ í•´ìˆ˜ìš•ê³¼ ë¶ˆê½ƒì¶•ì œê°€ íŠ¹íˆ ìœ ëª…í•©ë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” í•´ìš´ëŒ€í•´ìˆ˜ìš•ì¥, ê´‘ì•ˆëŒ€êµ(ê´‘ì•ˆë¦¬), ê°ì²œë¬¸í™”ë§ˆì„, í•´ë™ìš©ê¶ì‚¬, íƒœì¢…ëŒ€, ì˜ë„ í°ì—¬ìš¸ë¬¸í™”ë§ˆì„ì´ ìˆìŠµë‹ˆë‹¤. ìê°ˆì¹˜ì‹œì¥, ë¶€í‰ê¹¡í†µì‹œì¥, ì„œë©´ ë¨¹ìê³¨ëª©, í•´ìš´ëŒ€ í¬ì¥ë§ˆì°¨ì´Œì´ ë§›ì§‘ ì§€ì—­ìœ¼ë¡œ ìœ ëª…í•˜ë©°, ì˜ë„ ì¹´í˜ê±°ë¦¬, í•´ìš´ëŒ€ ì¹´í˜ê±°ë¦¬, ì „í¬ì¹´í˜ê±°ë¦¬ë„ ì¸ê¸°ì…ë‹ˆë‹¤. ìš”íŠ¸ íˆ¬ì–´, ì•¼ê²½ í¬ë£¨ì¦ˆ, ë¶€ì‚°ì‹œí‹°íˆ¬ì–´ ë²„ìŠ¤ ë“±ì˜ ì²´í—˜ í™œë™ì„ ì¦ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    },
    {
        "id": "KR-003",
        "category": "êµ­ë‚´ì—¬í–‰",
        "title": "ê²½ì£¼ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ê²½ì£¼ëŠ” ì‹ ë¼ ì²œë…„ì˜ ìˆ˜ë„ë¡œ, ë¶ˆêµ­ì‚¬, ì„êµ´ì•”, ì²¨ì„±ëŒ€, ì•ˆì••ì§€(ë™ê¶ê³¼ ì›”ì§€) ë“± ì—­ì‚¬ ìœ ì ì´ í’ë¶€í•©ë‹ˆë‹¤. ë„ë³´ì™€ ìì „ê±°ë¡œ ì‹œë‚´ ìœ ì ì„ ë‘˜ëŸ¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²½ì£¼ë¹µ, í™©ë‚¨ë¹µì´ ëŒ€í‘œ ê°„ì‹ì´ë©°, ë³´ë¬¸ê´€ê´‘ë‹¨ì§€ì—ì„œ ìˆ™ë°•í•˜ë©´ í¸ë¦¬í•©ë‹ˆë‹¤. ë´„ ë²šê½ƒê³¼ ê°€ì„ ë‹¨í’ ì‹œì¦Œì´ ìµœì ì…ë‹ˆë‹¤.",
    },
    {
        "id": "KR-004",
        "category": "êµ­ë‚´ì—¬í–‰",
        "title": "ê°•ë¦‰ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ê°•ë¦‰ì€ ë™í•´ì•ˆì˜ ëŒ€í‘œ ì—¬í–‰ì§€ë¡œ, ê²½í¬ëŒ€, ì£¼ë¬¸ì§„, ì•ˆëª©í•´ë³€ ì¹´í˜ê±°ë¦¬ê°€ ìœ ëª…í•©ë‹ˆë‹¤. ì„œìš¸ì—ì„œ KTXë¡œ ì•½ 2ì‹œê°„ ì†Œìš”ë©ë‹ˆë‹¤. ì´ˆë‹¹ìˆœë‘ë¶€, ê°ìì˜¹ì‹¬ì´ê°€ ëŒ€í‘œ ìŒì‹ì´ë©°, ì»¤í”¼ì˜ ë„ì‹œë¡œ ë¶ˆë¦´ ë§Œí¼ ì¹´í˜ ë¬¸í™”ê°€ ë°œë‹¬í–ˆìŠµë‹ˆë‹¤. ì—¬ë¦„ í•´ìˆ˜ìš•ê³¼ ê²¨ìš¸ ì„œí•‘ì´ ì¸ê¸°ì…ë‹ˆë‹¤.",
    },
    {
        "id": "KR-005",
        "category": "êµ­ë‚´ì—¬í–‰",
        "title": "ì„œìš¸ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ì„œìš¸ì€ í•œêµ­ì˜ ìˆ˜ë„ë¡œ, ê²½ë³µê¶, ë¶ì´Œí•œì˜¥ë§ˆì„, ëª…ë™, í™ëŒ€, ì´íƒœì›, ë‚¨ì‚°íƒ€ì›Œê°€ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. ì§€í•˜ì² ì´ ë§¤ìš° í¸ë¦¬í•˜ì—¬ ëŒ€ì¤‘êµí†µë§Œìœ¼ë¡œ ì£¼ìš” ê´€ê´‘ì§€ë¥¼ ëª¨ë‘ ë°©ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œì‹, ê¸¸ê±°ë¦¬ ìŒì‹, ë‹¤ì–‘í•œ ì„¸ê³„ ìš”ë¦¬ë¥¼ ì¦ê¸¸ ìˆ˜ ìˆìœ¼ë©°, ì‡¼í•‘ê³¼ K-pop ë¬¸í™” ì²´í—˜ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    },
    {
        "id": "JP-001",
        "category": "í•´ì™¸ì—¬í–‰",
        "title": "ë„ì¿„ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ë„ì¿„ëŠ” ì¼ë³¸ì˜ ìˆ˜ë„ë¡œ, ì‹œë¶€ì•¼, ì‹ ì£¼ì¿ , ì•„ì‚¬ì¿ ì‚¬(ì„¼ì†Œì§€), í•˜ë¼ì£¼ì¿ , ì•„í‚¤í•˜ë°”ë¼ê°€ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. ì¸ì²œì—ì„œ ë¹„í–‰ê¸°ë¡œ ì•½ 2ì‹œê°„ 30ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. ìŠ¤ì‹œ, ë¼ë©˜, í…í‘¸ë¼ ë“± ì¼ë³¸ ìŒì‹ì˜ ë³¸ê³ ì¥ì´ë©°, ë„ì¿„ ë””ì¦ˆë‹ˆëœë“œì™€ íŒ€ë© ì „ì‹œë„ ì¸ê¸°ì…ë‹ˆë‹¤. êµí†µì¹´ë“œ(Suica/PASMO)ë¡œ í¸ë¦¬í•˜ê²Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” ì„¼ì†Œì§€(ì•„ì‚¬ì¿ ì‚¬), ì‹œë¶€ì•¼ ìŠ¤í¬ë¨ë¸”, ë„ì¿„íƒ€ì›Œ, ë©”ì´ì§€ì‹ ê¶, ë„ì¿„ ìŠ¤ì¹´ì´íŠ¸ë¦¬, ìš°ì—ë…¸ê³µì›ì´ ìˆìŠµë‹ˆë‹¤. ì¸ í‚¤ì§€ ì™¸ì‹œì¥, ë¼ë©˜ ìš”ì½”ì´ˆ, ê¸´ì ìŠ¤ì‹œê±°ë¦¬, ì‹ ì£¼ì¿  ì´ìì¹´ì•¼ ê³¨ëª©ì´ ë§›ì§‘ ì§€ì—­ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤. í•˜ë¼ì£¼ì¿  ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬, ì•„í‚¤í•˜ë°”ë¼, ì‹œë¶€ì•¼109, ê¸´ì ë°±í™”ì ê±°ë¦¬ì—ì„œ ì‡¼í•‘ì„ ì¦ê¸¸ ìˆ˜ ìˆìœ¼ë©°, íŒ€ë©(teamLab), ë„ì¿„ ë””ì¦ˆë‹ˆëœë“œ/ì‹œ, ë¡œë´‡ ë ˆìŠ¤í† ë‘, ê¸°ëª¨ë…¸ ì²´í—˜ ë“±ì˜ í™œë™ë„ ì¸ê¸°ì…ë‹ˆë‹¤.",
    },
    {
        "id": "JP-002",
        "category": "í•´ì™¸ì—¬í–‰",
        "title": "ì˜¤ì‚¬ì¹´ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ì˜¤ì‚¬ì¹´ëŠ” ì¼ë³¸ì˜ 'ë¨¹ìê³¨ëª©' ë„ì‹œë¡œ, ë„í†¤ë³´ë¦¬, ì˜¤ì‚¬ì¹´ì„±, ìœ ë‹ˆë²„ì„¤ ìŠ¤íŠœë””ì˜¤ ì¬íŒ¬ì´ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. íƒ€ì½”ì•¼í‚¤, ì˜¤ì½”ë…¸ë¯¸ì•¼í‚¤, ì¿ ì‹œì¹´ì¸ ê°€ ëŒ€í‘œ ìŒì‹ì´ë©°, 'ì¿ ì´ë‹¤ì˜¤ë ˆ(ë¨¹ë‹¤ ì“°ëŸ¬ì§€ë‹¤)' ë¬¸í™”ê°€ ìœ ëª…í•©ë‹ˆë‹¤. êµí† , ë‚˜ë¼ì™€ ê°€ê¹Œì›Œ í•¨ê»˜ ì—¬í–‰í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.",
    },
    {
        "id": "TH-001",
        "category": "í•´ì™¸ì—¬í–‰",
        "title": "ë°©ì½• ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ë°©ì½•ì€ íƒœêµ­ì˜ ìˆ˜ë„ë¡œ, ì™•ê¶, ì™“ì•„ë£¬, ì™“í¬, ì¹´ì˜¤ì‚°ë¡œë“œê°€ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. ì¸ì²œì—ì„œ ì•½ 5ì‹œê°„ 30ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. íŒŸíƒ€ì´, ë˜ ì–Œê¿, ë§ê³ ìŠ¤í‹°í‚¤ë¼ì´ìŠ¤ ë“± íƒœêµ­ ìŒì‹ì´ ì €ë ´í•˜ê³  ë§›ìˆìŠµë‹ˆë‹¤. ì•¼ì‹œì¥ê³¼ ìˆ˜ìƒì‹œì¥ ì²´í—˜, íƒœêµ­ ë§ˆì‚¬ì§€ê°€ ì¸ê¸°ì…ë‹ˆë‹¤. 11~2ì›” ê±´ê¸°ê°€ ì—¬í–‰ ìµœì ê¸°ì…ë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” ì™•ê¶, ì™“ì•„ë£¬, ì™“í¬, ì§œëšœì§ ì£¼ë§ì‹œì¥, ì¹´ì˜¤ì‚°ë¡œë“œê°€ ìˆìŠµë‹ˆë‹¤. ì•¼ì™€ë(ì°¨ì´ë‚˜íƒ€ìš´), ë°©ëŒí‘¸ ê¸¸ê±°ë¦¬ ìŒì‹, ì•„ì´ì½˜ì‹œì•” í‘¸ë“œì½”íŠ¸ê°€ ë§›ì§‘ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤. ìˆ˜ìƒì‹œì¥(ë‹´ë„Œì‚¬ë‘ì•…), íƒœêµ­ ì „í†µ ë§ˆì‚¬ì§€, ë¬´ì—íƒ€ì´ ê´€ëŒ, ì¿ í‚¹í´ë˜ìŠ¤ ë“±ì˜ ì²´í—˜ í™œë™ë„ ì¦ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    },
    {
        "id": "VN-001",
        "category": "í•´ì™¸ì—¬í–‰",
        "title": "ë‹¤ë‚­ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "ë‹¤ë‚­ì€ ë² íŠ¸ë‚¨ ì¤‘ë¶€ì˜ í•´ì–‘ ë„ì‹œë¡œ, ë¯¸ì¼€ë¹„ì¹˜, ë°”ë‚˜í, í˜¸ì´ì•ˆ ì˜¬ë“œíƒ€ìš´, ì˜¤í–‰ì‚°ì´ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. ì¸ì²œì—ì„œ ì•½ 4ì‹œê°„ 30ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. ìŒ€êµ­ìˆ˜(í¼), ë°˜ë¯¸, ë¶„ì§œê°€ ëŒ€í‘œ ìŒì‹ì´ë©°, ë¬¼ê°€ê°€ ì €ë ´í•˜ì—¬ ê°€ì„±ë¹„ ì—¬í–‰ì§€ë¡œ ì¸ê¸°ì…ë‹ˆë‹¤. 3~8ì›”ì´ ì—¬í–‰ ìµœì ê¸°ì…ë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” ë¯¸ì¼€ë¹„ì¹˜, ë°”ë‚˜í(ê³¨ë“ ë¸Œë¦¿ì§€), ì˜¤í–‰ì‚°, í•œê°• ë“œë˜ê³¤ë¸Œë¦¿ì§€, ì°¸ ì¡°ê° ë°•ë¬¼ê´€ì´ ìˆìŠµë‹ˆë‹¤. í•œì‹œì¥, ë¯¸ì¼€ë¹„ì¹˜ í•´ì‚°ë¬¼, ê½ë‚¨ ê¸¸ê±°ë¦¬ ìŒì‹ì´ ë§›ì§‘ ì§€ì—­ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤. í˜¸ì´ì•ˆ ì˜¬ë“œíƒ€ìš´(UNESCO), ë°”êµ¬ë‹ˆë°° ì²´í—˜, ìŠ¤ë…¸í´ë§/ë‹¤ì´ë¹™ ë“±ì˜ í™œë™ì„ ì¦ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    },
    {
        "id": "FR-001",
        "category": "í•´ì™¸ì—¬í–‰",
        "title": "íŒŒë¦¬ ì—¬í–‰ ê°€ì´ë“œ",
        "content": "íŒŒë¦¬ëŠ” í”„ë‘ìŠ¤ì˜ ìˆ˜ë„ë¡œ, ì—í íƒ‘, ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€, ê°œì„ ë¬¸, ëª½ë§ˆë¥´ëœ¨, ì„¸ëŠê°• í¬ë£¨ì¦ˆê°€ ëŒ€í‘œ ê´€ê´‘ì§€ì…ë‹ˆë‹¤. ì¸ì²œì—ì„œ ì•½ 12ì‹œê°„ ì†Œìš”ë©ë‹ˆë‹¤. í¬ë£¨ì•„ìƒ, ì—ìŠ¤ì¹´ë¥´ê³ , ì™€ì¸ ë“± í”„ë‘ìŠ¤ ë¯¸ì‹ì˜ ì¤‘ì‹¬ì§€ì´ë©°, íŒ¨ì…˜ê³¼ ì˜ˆìˆ ì˜ ë„ì‹œì…ë‹ˆë‹¤. ë´„(4~6ì›”)ê³¼ ê°€ì„(9~10ì›”)ì´ ì—¬í–‰ ìµœì ê¸°ì…ë‹ˆë‹¤. ì£¼ìš” ê´€ê´‘ì§€ë¡œëŠ” ì—í íƒ‘, ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€, ê°œì„ ë¬¸, ëª½ë§ˆë¥´ëœ¨/ì‚¬í¬ë ˆì¾¨ë¥´, ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹, ì„¸ëŠê°• í¬ë£¨ì¦ˆê°€ ìˆìŠµë‹ˆë‹¤. ë§ˆë ˆì§€êµ¬ ë ˆìŠ¤í† ë‘, ìƒì œë¥´ë§¹ ì¹´í˜, ëª½ë§ˆë¥´ëœ¨ ë¹„ìŠ¤íŠ¸ë¡œê°€ ë§›ì§‘ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤. ìƒ¹ì ¤ë¦¬ì œ ê±°ë¦¬, ê°¤ëŸ¬ë¦¬ ë¼íŒŒì˜ˆíŠ¸, ë´‰ ë§ˆë¥´ì…°ì—ì„œ ì‡¼í•‘ì„ ì¦ê¸¸ ìˆ˜ ìˆìœ¼ë©°, ë² ë¥´ì‚¬ìœ  ê¶ì „(ë‹¹ì¼ì¹˜ê¸°), ì™€ì¸ í…Œì´ìŠ¤íŒ…, ì„¸ëŠê°• í¬ë£¨ì¦ˆ ë””ë„ˆ ë“±ì˜ ì²´í—˜ í™œë™ë„ ì¸ê¸°ì…ë‹ˆë‹¤.",
    },
    {
        "id": "TIP-001",
        "category": "ì—¬í–‰íŒ",
        "title": "ì—¬í–‰ ì§ ì‹¸ê¸° ì²´í¬ë¦¬ìŠ¤íŠ¸",
        "content": "ì—¬í–‰ ì§ ì‹¸ê¸° í•„ìˆ˜ í•­ëª©: ì—¬ê¶Œ, í•­ê³µê¶Œ, ìˆ™ì†Œ ì˜ˆì•½ í™•ì¸ì„œ, ì—¬í–‰ìë³´í—˜ ì„œë¥˜, í˜„ì§€ í†µí™”/ì¹´ë“œ, ì¶©ì „ê¸°, ì–´ëŒ‘í„°(êµ­ê°€ë³„ í™•ì¸), ìƒë¹„ì•½(ë‘í†µì•½, ì†Œí™”ì œ, ë°´ë“œ), ì„¸ë©´ë„êµ¬, ìì™¸ì„ ì°¨ë‹¨ì œ, ìš°ì‚°/ìš°ë¹„. ì§ì„ ì¤„ì´ë ¤ë©´ 3ì¼ ê¸°ì¤€ ì˜·ì„ ì¤€ë¹„í•˜ê³  ìˆ™ì†Œì—ì„œ ì„¸íƒí•˜ì„¸ìš”.",
    },
    {
        "id": "TIP-002",
        "category": "ì—¬í–‰íŒ",
        "title": "í™˜ì „ ê°€ì´ë“œ",
        "content": "í™˜ì „ íŒ: 1) ì¶œë°œ ì „ ì‹œì¤‘ì€í–‰ì—ì„œ ê¸°ë³¸ ê¸ˆì•¡ í™˜ì „ (ìˆ˜ìˆ˜ë£Œ ìš°ëŒ€ì¿ í° í™œìš©) 2) í˜„ì§€ ATMì—ì„œ í•„ìš”í•œ ë§Œí¼ ì¸ì¶œ (ìˆ˜ìˆ˜ë£Œ í™•ì¸) 3) íŠ¸ë˜ë¸”ì›”ë ›, íŠ¸ë˜ë¸”ë¡œê·¸ ë“± í•´ì™¸ ì „ìš© ì²´í¬ì¹´ë“œ í™œìš© 4) ê³µí•­ í™˜ì „ì€ ìˆ˜ìˆ˜ë£Œê°€ ë†’ìœ¼ë‹ˆ ìµœì†Œí•œë§Œ. ì¼ë³¸ì€ í˜„ê¸ˆ ë¬¸í™”ê°€ ê°•í•˜ë‹ˆ ë„‰ë„‰íˆ, ìœ ëŸ½ì€ ì¹´ë“œ ìœ„ì£¼ë¡œ ì¤€ë¹„í•˜ì„¸ìš”.",
    },
    {
        "id": "TIP-003",
        "category": "ì—¬í–‰íŒ",
        "title": "í•´ì™¸ì—¬í–‰ êµí†µ ê°€ì´ë“œ",
        "content": "í•´ì™¸ êµí†µ íŒ: 1) ì¼ë³¸: êµí†µì¹´ë“œ(Suica/PASMO) í•„ìˆ˜, JRíŒ¨ìŠ¤ ê³ ë ¤ 2) íƒœêµ­: ê·¸ë©(Grab) ì•± í•„ìˆ˜, BTS/MRT ì´ìš© 3) ìœ ëŸ½: ìœ ë ˆì¼íŒ¨ìŠ¤ ë˜ëŠ” ì €ê°€í•­ê³µ(ë¼ì´ì–¸ì—ì–´ ë“±) 4) ë™ë‚¨ì•„: ê·¸ë© íƒì‹œê°€ ì•ˆì „í•˜ê³  í¸ë¦¬ 5) êµ¬ê¸€ë§µ ë˜ëŠ” ë„¤ì´ë²„ë§µ(ì¼ë³¸) ì˜¤í”„ë¼ì¸ ì§€ë„ ë‹¤ìš´ë¡œë“œ ì¶”ì²œ",
    },
    {
        "id": "TIP-004",
        "category": "ì—¬í–‰íŒ",
        "title": "ì—¬í–‰ ì˜ˆì‚° ì ˆì•½ íŒ",
        "content": "ì—¬í–‰ ê²½ë¹„ ì ˆì•½ ë°©ë²•: 1) í•­ê³µê¶Œ: ë¹„ìˆ˜ê¸° ì˜ˆì•½, ìŠ¤ì¹´ì´ìŠ¤ìºë„ˆë¡œ ê°€ê²© ë¹„êµ, ê²½ìœ í¸ í™œìš© 2) ìˆ™ì†Œ: ì—ì–´ë¹„ì•¤ë¹„, í˜¸ìŠ¤í…”, ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤ í™œìš© 3) ì‹ë¹„: í˜„ì§€ ì‹œì¥/í¸ì˜ì  ì´ìš©, ì ì‹¬ì— ë¹„ì‹¼ ë ˆìŠ¤í† ë‘ ë°©ë¬¸ (ëŸ°ì¹˜ ì„¸íŠ¸ê°€ ì €ë ´) 4) êµí†µ: ëŒ€ì¤‘êµí†µ íŒ¨ìŠ¤ í™œìš©, ë„ë³´ ê´€ê´‘ 5) ê´€ê´‘: ë¬´ë£Œ íˆ¬ì–´, ë°•ë¬¼ê´€ ë¬´ë£Œ ì…ì¥ì¼ í™•ì¸",
    },
    {
        "id": "TIP-005",
        "category": "ì—¬í–‰íŒ",
        "title": "ë™ë‚¨ì•„ ì—¬í–‰ ì‹œ ì£¼ì˜ì‚¬í•­",
        "content": "ë™ë‚¨ì•„ ì—¬í–‰ ì£¼ì˜ì‚¬í•­: 1) ë¬¼ì€ ë°˜ë“œì‹œ ìƒìˆ˜ êµ¬ë§¤ (ìˆ˜ë—ë¬¼ ê¸ˆì§€) 2) ê¸¸ê±°ë¦¬ ìŒì‹ì€ ì‚¬ëŒ ë§ì€ ê³³ì—ì„œ 3) ì†Œë§¤ì¹˜ê¸° ì£¼ì˜ (í¬ë¡œìŠ¤ë°± ê¶Œì¥) 4) ì‚¬ì› ë°©ë¬¸ ì‹œ ë³µì¥ ê·œì • í™•ì¸ (ê¸´ë°”ì§€, ì–´ê¹¨ ê°€ë¦¬ê¸°) 5) ìì™¸ì„  ì°¨ë‹¨ì œ í•„ìˆ˜ 6) ëª¨ê¸° ê¸°í”¼ì œ ì¤€ë¹„ 7) ì—¬í–‰ìë³´í—˜ ê°€ì… í•„ìˆ˜",
    },
]

BUDGET_DB = {
    "ì œì£¼ë„": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 70000,
                "ì‹ë¹„": 35000,
                "êµí†µ": 30000,
                "ê´€ê´‘": 10000,
                "í•­ê³µ": 80000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 100000,
                "ì‹ë¹„": 50000,
                "êµí†µ": 40000,
                "ê´€ê´‘": 20000,
                "í•­ê³µ": 100000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 150000,
                "ì‹ë¹„": 80000,
                "êµí†µ": 50000,
                "ê´€ê´‘": 40000,
                "í•­ê³µ": 120000,
            },
        ]
    },
    "ë¶€ì‚°": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 60000,
                "ì‹ë¹„": 30000,
                "êµí†µ": 20000,
                "ê´€ê´‘": 10000,
                "í•­ê³µ/KTX": 50000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 80000,
                "ì‹ë¹„": 40000,
                "êµí†µ": 25000,
                "ê´€ê´‘": 15000,
                "í•­ê³µ/KTX": 60000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 120000,
                "ì‹ë¹„": 60000,
                "êµí†µ": 35000,
                "ê´€ê´‘": 25000,
                "í•­ê³µ/KTX": 70000,
            },
        ]
    },
    "ë„ì¿„": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 90000,
                "ì‹ë¹„": 40000,
                "êµí†µ": 15000,
                "ê´€ê´‘": 15000,
                "í•­ê³µ": 300000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 120000,
                "ì‹ë¹„": 50000,
                "êµí†µ": 20000,
                "ê´€ê´‘": 25000,
                "í•­ê³µ": 350000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 200000,
                "ì‹ë¹„": 80000,
                "êµí†µ": 30000,
                "ê´€ê´‘": 50000,
                "í•­ê³µ": 400000,
            },
        ]
    },
    "ë°©ì½•": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 50000,
                "ì‹ë¹„": 20000,
                "êµí†µ": 10000,
                "ê´€ê´‘": 10000,
                "í•­ê³µ": 350000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 70000,
                "ì‹ë¹„": 30000,
                "êµí†µ": 15000,
                "ê´€ê´‘": 20000,
                "í•­ê³µ": 400000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 120000,
                "ì‹ë¹„": 50000,
                "êµí†µ": 25000,
                "ê´€ê´‘": 35000,
                "í•­ê³µ": 450000,
            },
        ]
    },
    "ë‹¤ë‚­": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 40000,
                "ì‹ë¹„": 18000,
                "êµí†µ": 8000,
                "ê´€ê´‘": 10000,
                "í•­ê³µ": 300000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 60000,
                "ì‹ë¹„": 25000,
                "êµí†µ": 12000,
                "ê´€ê´‘": 15000,
                "í•­ê³µ": 350000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 100000,
                "ì‹ë¹„": 40000,
                "êµí†µ": 20000,
                "ê´€ê´‘": 25000,
                "í•­ê³µ": 400000,
            },
        ]
    },
    "íŒŒë¦¬": {
        "options": [
            {
                "name": "ì €ì˜ˆì‚°",
                "ìˆ™ë°•": 100000,
                "ì‹ë¹„": 50000,
                "êµí†µ": 15000,
                "ê´€ê´‘": 20000,
                "í•­ê³µ": 900000,
            },
            {
                "name": "ì¤‘ì˜ˆì‚°",
                "ìˆ™ë°•": 150000,
                "ì‹ë¹„": 70000,
                "êµí†µ": 20000,
                "ê´€ê´‘": 35000,
                "í•­ê³µ": 1000000,
            },
            {
                "name": "ê³ ì˜ˆì‚°",
                "ìˆ™ë°•": 250000,
                "ì‹ë¹„": 120000,
                "êµí†µ": 30000,
                "ê´€ê´‘": 60000,
                "í•­ê³µ": 1200000,
            },
        ]
    },
}

_vector_store = None


def _create_knowledge_base_documents() -> list:
    """Convert travel knowledge base to LangChain Document objects."""
    documents = []
    for item in TRAVEL_KNOWLEDGE_BASE:
        doc = Document(
            page_content=item["content"],
            metadata={
                "id": item["id"],
                "category": item["category"],
                "title": item["title"],
            }
        )
        documents.append(doc)
    return documents


def _get_or_initialize_vector_store():
    """Initialize FAISS vector store on first call, or return cached instance."""
    global _vector_store
    if _vector_store is not None:
        return _vector_store

    try:
        from langchain_upstage import UpstageEmbeddings
        from langchain_community.vectorstores import FAISS

        embeddings = UpstageEmbeddings(model="solar-embedding-1-large")
        documents = _create_knowledge_base_documents()
        _vector_store = FAISS.from_documents(documents, embeddings)
        logger.info("FAISS ë²¡í„° ìŠ¤í† ì–´ ì´ˆê¸°í™” ì„±ê³µ")
        return _vector_store
    except Exception as e:
        logger.warning(f"FAISS ì´ˆê¸°í™” ì‹¤íŒ¨, í‚¤ì›Œë“œ ê²€ìƒ‰ìœ¼ë¡œ í´ë°±: {e}")
        return None


def _keyword_fallback_search(query: str) -> str:
    """Keyword-based fallback search when FAISS fails."""
    query_lower = query.lower()
    for item in TRAVEL_KNOWLEDGE_BASE:
        if any(word in (item["title"] + " " + item["content"]).lower()
               for word in query_lower.split() if len(word) >= 2):
            return f"[{item['category']}] {item['title']}\n{item['content']}"
    return "ê´€ë ¨ ì—¬í–‰ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."


class TravelSearchInput(BaseModel):
    query: str = Field(description="ê²€ìƒ‰ ì¿¼ë¦¬ (ì˜ˆ: 'ì œì£¼ë„ ì—¬í–‰', 'í™˜ì „ íŒ')")


class WebSearchInput(BaseModel):
    query: str = Field(description="ê²€ìƒ‰í•  ì¿¼ë¦¬ (ì˜ˆ: 'ì œì£¼ë„ ë§›ì§‘ ì¶”ì²œ 2024', 'ë„ì¿„ ë²šê½ƒ ì‹œê¸°')")


@tool(args_schema=TravelSearchInput)
def search_travel_knowledge(query: str) -> str:
    """Search travel knowledge base using FAISS vector search."""
    logger.info(f"[Tool Call] search_travel_knowledge | query='{query}'")
    try:
        vector_store = _get_or_initialize_vector_store()
        if vector_store is not None:
            docs = vector_store.similarity_search(query, k=3)
            result = "\n\n".join(
                f"[{doc.metadata.get('category', '')}] {doc.metadata.get('title', '')}\n{doc.page_content}"
                for doc in docs
            )
            logger.debug(f"RAG ê²€ìƒ‰ ì™„ë£Œ: {len(docs)}ê°œ ë¬¸ì„œ ê²€ìƒ‰ë¨")
            return result
        # í´ë°±: í‚¤ì›Œë“œ ë§¤ì¹­
        logger.info("ë²¡í„° ìŠ¤í† ì–´ ì—†ìŒ, í‚¤ì›Œë“œ í´ë°± ê²€ìƒ‰ ì‚¬ìš©")
        return _keyword_fallback_search(query)
    except Exception as e:
        logger.warning(f"RAG ê²€ìƒ‰ ì‹¤íŒ¨, í‚¤ì›Œë“œ í´ë°± ì‚¬ìš©: {e}")
        return _keyword_fallback_search(query)


class BudgetInput(BaseModel):
    destination: str = Field(description="ì—¬í–‰ì§€ ì´ë¦„ (ì˜ˆ: 'ì œì£¼ë„', 'ë„ì¿„')")
    duration_days: int = Field(description="ì—¬í–‰ ê¸°ê°„ (ì¼ìˆ˜)", ge=1)
    user_budget: int | None = Field(default=None, description="ì‚¬ìš©ì ì˜ˆì‚° (ì›, ì„ íƒì‚¬í•­)")


@tool(args_schema=BudgetInput)
def estimate_budget(destination: str, duration_days: int, user_budget: int | None = None) -> str:
    """Estimate travel budget with multiple price tier options."""
    logger.info(f"[Tool Call] estimate_budget | destination='{destination}', duration_days={duration_days}, user_budget={user_budget}")
    try:
        matched_destination = None
        for key in BUDGET_DB.keys():
            if destination in key or key in destination:
                matched_destination = key
                break
        
        if not matched_destination:
            return f"'{destination}' ì˜ˆì‚° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ì› ë„ì‹œ: {', '.join(BUDGET_DB.keys())}"
        
        destination_data = BUDGET_DB[matched_destination]
        options = destination_data.get("options", [])
        
        if not options:
            return f"'{matched_destination}' ì˜ˆì‚° ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤."

        option_totals = []
        for option in options:
            option_name = option["name"]
            total = 0
            breakdown = []
            
            for cost_item, daily_cost in option.items():
                if cost_item == "name":
                    continue

                if "í•­ê³µ" in cost_item or "KTX" in cost_item:
                    cost = daily_cost
                    breakdown.append(f"    - {cost_item} (ì™•ë³µ): {cost:,}ì›")
                else:
                    cost = daily_cost * duration_days
                    breakdown.append(f"    - {cost_item} ({daily_cost:,}ì›/ì¼ Ã— {duration_days}ì¼): {cost:,}ì›")

                total += cost
            
            option_totals.append({
                "name": option_name,
                "total": total,
                "breakdown": breakdown
            })

        if user_budget is not None:
            affordable_options = [opt for opt in option_totals if opt["total"] <= user_budget]
            logger.info(f"ì˜ˆì‚° ë¹„êµ ì™„ë£Œ: {len(affordable_options)}/{len(option_totals)}ê°œ ì˜µì…˜ ê°€ëŠ¥")

            if not affordable_options:
                result = f"âš ï¸ {matched_destination} {duration_days}ì¼ ì—¬í–‰ (1ì¸ ê¸°ì¤€)\n\n"
                result += f"ì…ë ¥í•˜ì‹  ì˜ˆì‚°: {user_budget:,}ì›\n\n"
                result += "ì£„ì†¡í•©ë‹ˆë‹¤. ì…ë ¥í•˜ì‹  ì˜ˆì‚°ìœ¼ë¡œëŠ” ê°€ëŠ¥í•œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.\n\n"
                result += "ğŸ’¡ ì°¸ê³ : ìµœì†Œ ì˜ˆì‚° ì˜µì…˜\n\n"
                
                min_option = min(option_totals, key=lambda x: x["total"])
                result += f"  [{min_option['name']}] ì´ {min_option['total']:,}ì›\n"
                result += "\n".join(min_option["breakdown"])
                result += f"\n\n  ë¶€ì¡±í•œ ê¸ˆì•¡: {min_option['total'] - user_budget:,}ì›"

                return result
            else:
                result = f"âœ… {matched_destination} {duration_days}ì¼ ì—¬í–‰ (1ì¸ ê¸°ì¤€)\n\n"
                result += f"ì…ë ¥í•˜ì‹  ì˜ˆì‚°: {user_budget:,}ì›\n\n"
                result += f"ì˜ˆì‚° ë‚´ ê°€ëŠ¥í•œ ì˜µì…˜: {len(affordable_options)}ê°œ\n\n"
                
                for i, opt in enumerate(affordable_options, 1):
                    result += f"{i}. [{opt['name']}] ì´ {opt['total']:,}ì› (ì—¬ìœ : {user_budget - opt['total']:,}ì›)\n"
                    result += "\n".join(opt["breakdown"])
                    result += "\n\n"

                return result
        else:
            result = f"ğŸ’° {matched_destination} {duration_days}ì¼ ì—¬í–‰ ì˜ˆì‚° ì˜µì…˜ (1ì¸ ê¸°ì¤€)\n\n"

            for i, opt in enumerate(option_totals, 1):
                result += f"{i}. [{opt['name']}] ì´ {opt['total']:,}ì›\n"
                result += "\n".join(opt["breakdown"])
                result += "\n\n"

            result += "ğŸ’¡ TIP: ì˜ˆì‚°ì„ ì…ë ¥í•˜ì‹œë©´ í•´ë‹¹ ì˜ˆì‚°ìœ¼ë¡œ ê°€ëŠ¥í•œ ì˜µì…˜ë§Œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.\n"
            result += "ì°¸ê³ : ì‹¤ì œ ë¹„ìš©ì€ ì‹œì¦Œ, ì˜ˆì•½ ì‹œê¸°, ê°œì¸ ì†Œë¹„ ìŠµê´€ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

            return result

    except Exception as e:
        return f"ì˜ˆì‚° ì¶”ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"


@tool(args_schema=WebSearchInput)
def web_search(query: str) -> str:
    """Perform Google web search using Serper API for real-time travel information."""
    logger.info(f"[Tool Call] web_search | query='{query}'")
    try:
        api_key = os.getenv("SERPER_API_KEY")
        if not api_key:
            logger.warning("Serper API í‚¤ ë¯¸ì„¤ì •")
            return "ì›¹ ê²€ìƒ‰ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (SERPER_API_KEY ë¯¸ì„¤ì •). ë‚´ë¶€ ì§€ì‹ë² ì´ìŠ¤ë¥¼ í™œìš©í•´ì£¼ì„¸ìš”."

        headers = {
            "X-API-KEY": api_key,
            "Content-Type": "application/json",
        }
        payload = {
            "q": query,
            "gl": "kr",
            "hl": "ko",
            "num": 5,
        }

        response = requests.post(
            "https://google.serper.dev/search",
            headers=headers,
            json=payload,
            timeout=10,
        )
        response.raise_for_status()
        data = response.json()

        results = []

        knowledge_graph = data.get("knowledgeGraph", {})
        if knowledge_graph:
            knowledge_graph_info = f"[ì§€ì‹ íŒ¨ë„] {knowledge_graph.get('title', '')}"
            if knowledge_graph.get("description"):
                knowledge_graph_info += f": {knowledge_graph['description']}"
            results.append(knowledge_graph_info)

        for item in data.get("organic", [])[:5]:
            title = item.get("title", "")
            snippet = item.get("snippet", "")
            results.append(f"- {title}: {snippet}")

        if not results:
            logger.info("ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ")
            return f"'{query}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."

        logger.info(f"ì›¹ ê²€ìƒ‰ ì™„ë£Œ: {len(results)}ê°œ ê²°ê³¼")
        return f"ì›¹ ê²€ìƒ‰ ê²°ê³¼ ({query}):\n\n" + "\n".join(results)

    except requests.exceptions.Timeout:
        logger.error("ì›¹ ê²€ìƒ‰ íƒ€ì„ì•„ì›ƒ")
        return f"ì›¹ ê²€ìƒ‰ ì‹œê°„ ì´ˆê³¼. ë‚´ë¶€ ì§€ì‹ë² ì´ìŠ¤ë¥¼ í™œìš©í•´ì£¼ì„¸ìš”."
    except requests.exceptions.RequestException as e:
        logger.error(f"ì›¹ ê²€ìƒ‰ ìš”ì²­ ì˜¤ë¥˜: {e}")
        return f"ì›¹ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}. ë‚´ë¶€ ì§€ì‹ë² ì´ìŠ¤ë¥¼ í™œìš©í•´ì£¼ì„¸ìš”."
    except Exception as e:
        logger.error(f"ì›¹ ê²€ìƒ‰ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        return f"ì›¹ ê²€ìƒ‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}"


RESEARCH_TOOLS = [search_travel_knowledge, estimate_budget, web_search]
